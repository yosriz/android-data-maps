<script src="d3.min.js"></script>
<script src="topojson.min.js"></script>
<script src="datamaps.world.min.js"></script>
<div
        id="container"
        style="position: relative; width: 1600px; height: 1040px;"></div>
<script>
	document.addEventListener("DOMContentLoaded", function(event) {
		loadingListener.loadSuccess();
	});
	document.getElementById('container').style.width = mapData.getWidth() + 'px';
	document.getElementById('container').style.height = mapData.getHeight() + 'px';	
	
    var map = new Datamap({
		element: document.getElementById('container'),
		projection: 'mercator',
		fills: {
            defaultFill: '#b2b2b2'
        }, 
	});
	var height = mapData.getMarkerPinHeight();
	var width = mapData.getMarkerPinWidth();
	
	 function handleMarkers (layer, data, options ) {
    var self = this,
        fillData = this.options.fills,
        svg = this.svg;

    if ( !data || (data && !data.slice) ) {
      throw "Datamaps Error - markers must be an array";
    }

    var markers = layer.selectAll('image.datamaps-marker').data( data, JSON.stringify );

    markers
      .enter()
        .append('image')
        .attr('class', 'datamaps-marker')
        .attr('xlink:href', function( datum ) {
          return datum.iconUrl || options.defaultIcon;
        })
        .attr('height', height)
        .attr('width', width)
        .attr('x', function ( datum ) {
          var latLng;
          if ( datumHasCoords(datum) ) {
            latLng = self.latLngToXY(datum.latitude, datum.longitude);
          }
          else if ( datum.centered ) {
            if ( datum.centered === 'USA' ) {
              latLng = self.projection([-98.58333, 39.83333])
            } else {
              latLng = self.path.centroid(svg.select('path.' + datum.centered).data()[0]);
            }
          }
          if ( latLng ) return latLng[0] - width /2 ;
        })
        .attr('y', function ( datum ) {
          var latLng;
          if ( datumHasCoords(datum) ) {
            latLng = self.latLngToXY(datum.latitude, datum.longitude);
          }
          else if ( datum.centered ) {		  
			  if ( datum.centered === 'USA' ) {
				  latLng = self.projection([-98.58333, 39.83333])
				} else {
				  latLng = self.path.centroid(svg.select('path.' + datum.centered).data()[0]);
				}              
          }
          if ( latLng ) return latLng[1] - height;
        })

   
    markers.exit()
      .transition()
        .attr("height", 0)
        .remove();

    function datumHasCoords (datum) {
      return typeof datum !== 'undefined' && typeof datum.latitude !== 'undefined' && typeof datum.longitude !== 'undefined';
    }

}
     map.addPlugin('markers', handleMarkers)

	 var countriesArray = JSON.parse(mapData.getCountriesJson());
	 var markersArray = new Array(countriesArray.length);
	 for (var i = 0 ; i < countriesArray.length; i++){
			markersArray[i] =  {centered : countriesArray[i]};
	 }
     function setMarkers() {
       map.markers(
	    markersArray,
        {defaultIcon: 'geochart_pin.png'});
     }
       
       
       d3.select('#clear').on('click', function() {
         map.markers([]);
       })
       
       d3.select('#set').on('click', setMarkers);
        
       setMarkers();	   


</script>